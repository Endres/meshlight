{% extends "bootstrap/base.html" %}
{%- block styles %}
{{super()}}
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <style>
      ul.circle {
        display: block;
        margin: 0 auto;
        list-style-type: none;
        padding: 22px;
        width: 300px;
        height: 300px;
      }

      ul.circle li {
        -moz-border-radius: 100%;
        -webkit-border-radius: 100%;
        background-color: #000;
        color: rgba(128, 128, 128, 0.5);
        position: absolute;
        margin: 0;
        height: 48px;
        width: 48px;
        text-align: center;
        font-size: 2em;
      }

      .range-container {
        display: block;
      }

      .range-container .custom-range {
        width: 85%;
      }

      .range-container output {
        width: 15%;
        text-align: right;
        display: block;
        float: right;
      }
    </style>
{%- endblock styles %}
{% block scripts %}
{{super()}}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>
<script type="text/javascript">
  function drawCircle(selector) {
    var total = $(selector).length;
    var alpha = Math.PI * 2 / total;
    var angle = -90;
    angle *= Math.PI / 180;
    var radius = $(selector).parent().width() / 2;

    $(selector).each(function(index) {
      var theta = alpha * index;
      var pointx  =  Math.floor(Math.cos( theta + angle ) * radius) + radius;
      var pointy  = Math.floor(Math.sin( theta + angle ) * radius) + radius;

      $(this).css("margin-left", pointx - $(selector).width()/2 + "px");
      $(this).css("margin-top", pointy - $(selector).height()/2 + "px");
    });
  }
</script>
<script type="text/javascript">
  var circleLength = 0;

  function updateCircles(newLength) {
    while (newLength > circleLength) {
      circleLength += 1;
      $("ul.circle").append($("<li></li>").text(circleLength));
      drawCircle("ul.circle li");
    }
    while (newLength < circleLength) {
      circleLength -= 1;
      $("ul.circle li").last().remove();
      drawCircle("ul.circle li");
    }
  }

  function updateFrame() {
    $.get("/api/get_frame").done(function(response) {
      $("#fps").text(response["fps"]);
      updateCircles(response["pixel_count"]);
      var count = Math.min(response["color_data"].length / 3, $("ul.circle li").length);
      for (var i = 0; i < count; i++) {
        $("ul.circle li").eq(i).text(i);
        var r = response["color_data"][i * 3];
        var g = response["color_data"][i * 3 + 1];
        var b = response["color_data"][i * 3 + 2];
        $("ul.circle li").eq(i).css("backgroundColor", "rgb(" + r + "," + g + "," + b + ")");
      }
      setTimeout("updateFrame();", 50);
    }).fail(function() {
      $("ul.circle li").text("?");
      // TODO: implement same as on arduino, fade to black after some time
      setTimeout("updateFrame();", 1000);
    });
  }

  var sequence_data = null;
  var animations = [];

  function isEqual(obj1, obj2) {
    return JSON.stringify(obj1) === JSON.stringify(obj2);
  }

  function eventString(e) {
    if (e["type"] == "Always") {
      return e["type"];
    }
    var s = "";
    if (e["until_flag"]) { //TODO
      s = "Until ";
    }
    s += e["type"];
    if (e["params"]) { //TODO
      s += "(" + e["params"].join(", ") + ")"; // maybe extend to support various formats like hours:minutes etc.
    }
    return s;
  }

  function durationString(d) {
    var s = [];
    if (d > 24*60*60) {
      var n = Math.floor(d / (24*60*60));
      s.push(n + (n == 1 ? " Day" : " Days"));
      d = (d % (24*60*60));
    }
    if (d > 60*60) {
      var n = Math.floor(d / (60*60));
      s.push(n + (n == 1 ? " Hour" : " Hours"));
      d = (d % (60*60));
    }
    if (d > 60) {
      var n = Math.floor(d / 60);
      s.push(n + (n == 1 ? " Minute" : " Minutes"));
      d = (d % 60);
    }
    if (d != 0) {
      s.push(d + (d == 1 ? " Second" : " Seconds"));
    }
    if (s.length < 2) {
      return s[0];
    } else {
      s[s.length - 2] += " and " + s.pop();
      //s[s.length - 1] = "and " + s[s.length - 1];
    }
    return s.join(", ");
  }

  function updateData() {
    $.get("/api/get_data").done(function(response) {
      $("#fps").text(response["fps"]);
      if (!isEqual(response["animations"], animations)) {
        animations = response["animations"];
        // TODO selected item
        var options = $.map(animations, function(o, name) {
          return $("<option />").text(name);
        });
        $("#mode").empty().append($("<option />").text("Automatic Mode")).append(options).change();
      }
      if (!isEqual(response["sequence"], sequence_data)) {
        sequence_data = response["sequence"];
        var rows = $.map(sequence_data, function(row) {
          var active = ("is_active" in row && row["is_active"]);
          //if (active)
          //  $("#options").html(row["animation"]); // TODO params
          return "<tr><td>" +
            (active ? "<i class='fa fa-arrow-right'></i>" : "") +
            "</td><td>" + row["animation"] + "</td><td>" +
            durationString(row["duration"]) + "</td><td>" +
            eventString(row["event"]) + "</td></tr>";
        });
        $("#sequence tbody").html(rows.join(""));
      }
      setTimeout("updateData();", 1000);
    }).fail(function() {
      // TODO: what to do on fail?
      setTimeout("updateData();", 1000);
    });
  }

  var option_animation = null;

  function changeOption() {
    if (!option_animation)
      return;
    console.log($(this).attr("data-option"), $(this).val());
    // TODO send back to server
  }

  function updateOptions(animation) {
    $("#options-title").text(animation);
    option_animation = animation;
    var option_id = 0;
    var options = $.map(animations[animation], function(params, option) {
      var min_value = params[0];
      var max_value = params[1];
      var default_value = params[2];
      var type = params[3];

      var ret = [$("<label />").attr("for", "opt-" + option_id).text(option)];

      switch (type) {
        case "slider-int":
        case "slider-duration":
        case "slider-float":
        // TODO maybe handle different sliders differently
        var input = $("<input />").attr("type", "range").
          addClass("custom-range").attr("id", "opt-" + option_id).
          attr("min", min_value).attr("max", max_value).val(default_value).
          attr("data-option", option).change(changeOption).
          on("input", function() {
            $("#" + this.id + "-val").val($(this).val());
          });
        if (type == "slider-float") {
          input.attr("step", "0.01");
        }
        ret.push($("<div />").addClass("range-container").append(input).
          append($("<output />").attr("id", "opt-" + option_id + "-val").
          val(default_value)));
        break;

        default:
        ret.push($("<input />").attr("type", "text").addClass("form-control").
          attr("id", "opt-" + option_id).val(default_value).
          attr("data-option", option).change(changeOption));
      }

      option_id ++;

      return ret;
    });
    $("#options").empty().append(options);
  }

  $("#add_sequence").click(function() {
    if (!option_animation)
      return;
    alert("not implemented");
  });

  $("#mode").change(function() {
    var new_animation = $(this).val();
    if (new_animation in animations) {
      // TODO load config options for single animation, send single animation change
      updateOptions(new_animation);
      $("#add_sequence").removeClass("disabled");
    } else {
      // Automatic Mode
      // TODO load config options for current auto animation, send auto animation change
      option_animation = null;
      $("#options-title").text("Automatic Mode");
      $("#options").text("Not implemented");
      $("#add_sequence").addClass("disabled");
    }
  });

  $(document).ready(function() {
    drawCircle("ul.circle li");
    updateData();
    updateFrame();
    $('tbody').sortable({
      removeOnSpill: true
    });
  });

  $(window).bind('beforeunload', function(e) {
    if (false) { // TODO
      var message = "You have unsaved changes on this page. Do you want to leave this page and discard your changes or stay on this page?";
      e.returnValue = message;
      return message;
    }
  });
</script>
{% endblock scripts %}
{% block navbar %}
    <nav class="navbar navbar-light bg-light">
      <a class="navbar-brand" href="#">MeshLight Server v1.0</a>
    </nav>
{% endblock navbar %}
{% block content %}
    <main role="main" class="container mt-4">
      <div class="card-deck">
        <div class="card mb-3">
          <div class="card-header">General</div>
          <div class="card-body">
            FPS: <span id="fps">{{ fps }}</span>
            <div class="form-group">
              <label for="mode">Mode (Auto or Single)</label>
              <select class="custom-select" deluminate_imagetype="unknown" id="mode">
                <option selected="">Automatic Mode</option>
              </select>
            </div>
            Max FPS, Number of Spots, Go back to Automatic Mode (on, off)
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-header">Animation Options (<span id="options-title"></span>)</div>
          <div class="card-body" id="options">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="add_sequence">Add to Sequence</button>
          </div>
        </div>
        <div class="w-100 d-none d-sm-block d-md-none"><!-- wrap on sm --></div>
        <div class="card mb-3" style="min-width: 340px;">
          <div class="card-body">
            <ul class="circle"></ul>
          </div>
        </div>
      </div>
      <div class="card mb-3">
        <div class="card-header">Automatic Sequence</div>
        <div class="card-body">
          <div class="alert alert-info alert-dismissible fade show" role="alert">
            NOT IMPLEMENTED! Drag to move sequence positions. Drag outside the area to remove the entry.
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <table class="table table-striped table-hover" id="sequence">
            <thead>
              <tr><th style="width: 32px;"></th><th>Animation</th><th>Duration</th><th>Event</th></tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary">Apply</button>
          <button type="button" class="btn btn-secondary disabled">Revert</button>
        </div>
      </div>
    </main>
{% endblock %}
